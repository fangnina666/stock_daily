import pandas as pd
from bs4 import BeautifulSoup
import re
import requests
import time
import random
from typing import List, Dict, Optional, Tuple
import urllib3
import os

# --- 這裡的輔助函數與前一版相同，保持不變 ---
USER_AGENTS = [
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36',
]

def get_stock_info(cell) -> Optional[Dict[str, str]]:
    script_tag = cell.find('script')
    a_tag = cell.find('a')
    stock_code, stock_name = None, None
    if script_tag and script_tag.string:
        match = re.search(r"GenLink2stk\('AS(\w+)',\s*'(.*)'\);", script_tag.string)
        if match: stock_code, stock_name = match.groups()
    elif a_tag:
        href = a_tag.get('href', '')
        match = re.search(r"Link2Stk\('([\w\d\w]+)'\)", href)
        if match:
            stock_code = match.group(1)
            stock_name = a_tag.get_text(strip=True)
    if stock_code: return {'code': stock_code, 'name': stock_name}
    return None

def parse_broker_table(table_tag, parent_broker_code: str, parent_broker_name: str, branch_name: str) -> List[Dict]:
    records = []
    for row in table_tag.find_all('tr')[2:]:
        cells = row.find_all('td')
        if len(cells) != 4: continue
        stock_info = get_stock_info(cells[0])
        if not stock_info: continue
        try:
            buy_volume = int(cells[1].get_text(strip=True).replace(',', ''))
            sell_volume = int(cells[2].get_text(strip=True).replace(',', ''))
        except (ValueError, IndexError):
            continue
        records.append({
            '股票代號': stock_info['code'], '股票名稱': stock_info['name'],
            '母券商代號': parent_broker_code, '母券商名稱': parent_broker_name,
            '子券商名稱': branch_name, '買入張數': buy_volume, '賣出張數': sell_volume,
        })
    return records

def parse_page_content(html_content: str, broker_info: Dict) -> Tuple[List[Dict], Optional[str]]:
    soup = BeautifulSoup(html_content, 'html.parser')
    data_date = None
    date_div = soup.find('div', class_='t11')
    if date_div:
        match = re.search(r'資料日期：(\d{8})', date_div.get_text())
        if match: data_date = match.group(1)
    all_header_cells = soup.find_all('td', class_='t2', attrs={'colspan': '4'})
    buy_table, sell_table = None, None
    for cell in all_header_cells:
        text = cell.get_text()
        if "買超" in text: buy_table = cell.find_parent('table')
        elif "賣超" in text: sell_table = cell.find_parent('table')
    page_records = []
    if buy_table: page_records.extend(parse_broker_table(buy_table, **broker_info))
    if sell_table: page_records.extend(parse_broker_table(sell_table, **broker_info))
    return page_records, data_date

def parse_raw_broker_string(raw_string: str) -> List[Dict]:
    broker_list = []
    parent_groups = raw_string.strip().split(';')
    for group in parent_groups:
        if not group.strip(): continue
        branches = group.strip().split('!')
        if not branches: continue
        try:
            parent_code, parent_name = branches[0].split(',', 1)
            parent_code = parent_code.strip()
            parent_name = re.sub(r'^\(.*\)', '', parent_name.strip()).replace("證券", "")
        except ValueError: continue
        for branch_str in branches:
            try:
                branch_code, branch_name = branch_str.split(',', 1)
                branch_code, branch_name = branch_code.strip(), branch_name.strip()
                if "(停)" in branch_name: continue
                broker_list.append({
                    'parent_broker_code': parent_code, 'parent_broker_name': parent_name,
                    'b': branch_code, 'branch_name': branch_name
                })
            except ValueError: continue
    return broker_list

def main():
    raw_broker_data = """
    6010,犇亞證券!6010,犇亞證券!6012,犇亞-網路!0036003000310064,犇亞-鑫豐;6620,口袋證券!6620,口袋證券;1030,土銀!1030,土銀!1039,土銀-士林!1031,土銀-台中!1032,土銀-台南!1036,土銀-玉里!0031003000330043,土銀-白河!1038,土銀-和平!1037,土銀-花蓮!0031003000330046,土銀-南港!0031003000330041,土銀-建國!1033,土銀-高雄!1035,土銀-新竹!1034,土銀-嘉義!0031003000330042,土銀-彰化;8890,大和國泰!8890,大和國泰;6460,大昌!6460,大昌!6462,大昌-安康!6465,大昌-桃園!6463,大昌-新竹!6464,大昌-新店!6461,大昌-樹林;5050,大展!5050,大展!5058,大展-台南;8770,大鼎(停)!8770,大鼎(停);6160,中國信託!6160,中國信託!6161,中國信託-三重!0036003100360041,中國信託-中壢!6164,中國信託-文心!6163,中國信託-永康!6162,中國信託-忠孝!6167,中國信託-松江!003600310036004b,中國信託-高雄!0036003100360058,中國信託-國際證券!6165,中國信託-新竹!6168,中國信託-嘉義;8520,中農!8520,中農;9800,元大!9800,元大證券!9813,元大-八德!0039003800380043,元大-三重!0039003800330047,元大-上新莊!9897,元大-土城!9875,元大-土城永寧!9822,元大-土城學府!003900380031006a,元大-士林!9893,元大-大天母!0039003800390055,元大-大甲!0039003800390047,元大-大同!003900380033004e,元大-大安!0039003800310067,元大-大里!0039003800330057,元大-大里德芳!9846,元大-大直!9814,元大-大益!003900380031007a,元大-大統!0039003800330069,元大-大雅!9815,元大-大灣!003900380039005a,元大-小港!0039003800300061,元大-中山北路!0039003800390065,元大-中和!9834,元大-中壢!003900380033006a,元大-仁愛!003900380039004e,元大-內湖!9867,元大-內湖民權!0039003800320043,元大-六合!0039003800310049,元大-天母!0039003800310051,元大-太平!9868,元大-文心!9854,元大-文心興安!0039003800300043,元大-斗六!9884,元大-斗信!003900380033004d,元大-木柵!0039003800390056,元大-北三重!0039003800390064,元大-北屯!0039003800390041,元大-北投!0039003800300044,元大-北府!9837,元大-北港!003900380039006b,元大-古亭!9812,元大-台中!0039003800390042,元大-台中中港!0039003800300068,元大-台北!9896,元大-台南!9831,元大-四維!0039003800390044,元大-左營!0039003800390058,元大-民生三民!0039003800310056,元大-民雄!9891,元大-永和!9852,元大-永春!9829,元大-永康!9824,元大-向上!003900380039004c,元大-成功!0039003800390051,元大-汐止!0039003800310052,元大-竹山!0039003800310042,元大-竹北!0039003800330066,元大-竹東!0039003800330056,元大-竹南!003900380030004b,元大-竹科!0039003800300077,元大-西屯!9873,元大-西門(停)!0039003800310069,元大-西螺!0039003800300064,元大-沙鹿!0039003800310065,元大-佳里!9863,元大-和平!0039003800350046,元大-岡山!0039003800300075,元大-府城!9871,元大-忠孝!0039003800320046,元大-忠孝鼎富!9817,元大-東泰!0039003800390066,元大-東港!0039003800330042,元大-林森!003900380031004b,元大-林園!0039003800390043,元大-板橋!9879,元大-板橋三民!0039003800310070,元大-松山!9801,元大-松江!9856,元大-花蓮!003900380030006c,元大-虎尾!003900380031004e,元大-金門!9878,元大-金華!0039003800380056,元大-長庚!003900380039006d,元大-信義!003900380031006d,元大-前金!9853,元大-南屯!0039003800310044,元大-南投!9862,元大-南京!0039003800300051,元大-南崁!0039003800300052,元大-南海!0039003800340045,元大-南勢角!9892,元大-屏東!0039003800310068,元大-屏東民生!0039003800310072,元大-屏南!003900380031004d,元大-苗栗!0039003800390061,元大-苑裡!9889,元大-員林!9835,元大-員林中山!0039003800380042,元大-桃園!9894,元大-桃興!0039003800390045,元大-草屯!0039003800390046,元大-高雄!003900380039007a,元大-國際證券!0039003800390059,元大-基隆!003900380036004b,元大-基隆孝二!0039003800310053,元大-崇德!9899,元大-淡水!0039003800300065,元大-清水!003900380031004c,元大-莒光!0039003800390053,元大-鹿港!0039003800320042,元大-博愛!9872,元大-復北!9833,元大-敦化!0039003800390050,元大-敦南!0039003800340048,元大-景美!0039003800310045,元大-發財!0039003800310079,元大-善化!0039003800310055,元大-華山!0039003800310058,元大-新生!9816,元大-新竹!9859,元大-新竹經國!0039003800340043,元大-新店中正!9869,元大-新盛!9898,元大-新莊!9825,元大-新營!0039003800370041,元大-楊梅!0039003800310071,元大-萬華!9887,元大-經紀部!0039003800310043,元大-路竹!0039003800390067,元大-嘉義!0039003800310047,元大-彰化!003900380039004a,元大-彰化民生!003900380031006e,元大-旗山!0039003800310046,元大-福營!003900380033005a,元大-鳳山!0039003800350043,元大-鳳中!003900380031005a,元大-潮州!003900380033004b,元大-學甲!003900380039006a,元大-樹林!0039003800330055,元大-頭份!003900380034004b,元大-館前!9858,元大-龍潭!0039003800310061,元大-歸仁!9838,元大-豐原!0039003800390057,元大-豐原站前!9874,元大-雙和!0039003800320041,元大-羅東!9857,元大-蘆洲!0039003800390049,元大-蘆洲中正!0039003800310041,元大-鶯歌!9888,元大-鑫永和;2200,元大期貨!2200,元大期貨;5920,元富!5920,元富!5923,元富-三重!0035003900320044,元富-大昌!003500390032006c,元富-大裕!0035003900320067,元富-中原!0035003900320069,元富-中港!003500390032004c,元富-中壢!003500390032007a,元富-文心!0035003900320075,元富-世貿!0035003900320065,元富-古亭(停)!5925,元富-台中!5929,元富-台南!5926,元富-四維(停)!0035003900320042,元富-永和!0035003900320057,元富-吉利!0035003900320050,元富-同大!003500390032005a,元富-安南!003500390032006d,元富-成功!003500390032006e,元富-西松!0035003900320077,元富-佳里!0035003900320055,元富-宜蘭!5927,元富-林園!0035003900320062,元富-板橋!0035003900320061,元富-松德!0035003900320079,元富-花蓮!003500390032004e,元富-虎尾!0035003900320048,元富-信義!0035003900320045,元富-城中!0035003900320072,元富-城東!0035003900320071,元富-屏東!0035003900320059,元富-埔里!0035003900320076,元富-桃園!0035003900320063,元富-烏日!0035003900320058,元富-草屯!5921,元富-高雄!0035003900320066,元富-國際證券!0035003900320053,元富-基隆!0035003900320051,元富-敦南!0035003900320047,元富-新竹!5922,元富-新店!5928,元富-新莊!003500390032006f,元富-新興!0035003900320049,元富-嘉義!003500390032004d,元富-彰化!0035003900320043,元富-潮州!0035003900320041,元富-緯城;5960,日茂!5960,日茂!5962,日茂-南投!5961,日茂-埔里;5660,日進!5660,日進;7750,北城!7750,北城證券;6110,台中銀!6110,台中銀!6115,台中銀-台北!6114,台中銀-員林!6116,台中銀-高雄!0036003100310041,台中銀-豐原;7120,台安!7120,台安;8150,台新!8150,台新證券!8156,台新-三民!0038003100350053,台新-中壢!0038003100350042,台新-台中!8159,台新-台南!8157,台新-左楠!8158,台新-松江!0038003100350048,台新-屏東!8151,台新-建北!0038003100350041,台新-高雄!003800310035005a,台新-國際證券!8152,台新-新莊!0038003100350059,台新-新營;3000,台新銀!3000,台新銀;1090,台灣工銀!1090,台灣工銀;8910,台灣巴克萊!8910,台灣巴克萊;1110,台灣企銀!1110,台灣企銀!1113,台灣企銀-九如!0031003100310043,台灣企銀-三民!1115,台灣企銀-太平!0031003100310046,台灣企銀-北高雄!1111,台灣企銀-台中!1112,台灣企銀-台南!0031003100310041,台灣企銀-民雄!1117,台灣企銀-竹北!1119,台灣企銀-岡山!1116,台灣企銀-屏東!0031003100310042,台灣企銀-建成!0031003100310047,台灣企銀-埔墘!0031003100310045,台灣企銀-桃園!1114,台灣企銀-嘉義!1118,台灣企銀-豐原;1380,台灣匯立證券!1380,台灣匯立證券;1470,台灣摩根士丹利!1470,台灣摩根士丹利;6450,永全!6450,永全證券!6452,永全-八德!6451,永全-南崁;5600,永興!5600,永興!5604,永興-大墩!5602,永興-水湳!5603,永興-台中;9A00,永豐金!0039004100300030,永豐金證券!003900410039004b,永豐金-三重!0039004100390038,永豐金-大園!0039004100390055,永豐金-中正!0039004100390042,永豐金-中和!0039004100390066,永豐金-中盛(停)!0039004100390039,永豐金-中壢!0039004100390067,永豐金-內湖!0039004100390047,永豐金-天母!0039004100390072,永豐金-北高雄!0039004100390064,永豐金-古亭!003900410039004c,永豐金-台中!0039004100390068,永豐金-台南!0039004100390057,永豐金-市政!0039004100390063,永豐金-永康!0039004100390050,永豐金-竹北!0039004100390058,永豐金-竹科!0039004100390044,永豐金-忠孝!0039004100390059,永豐金-板盛!003900410039004a,永豐金-板新!0039004100390045,永豐金-板橋(停)!0039004100390031,永豐金-松山!0039004100390062,永豐金-虎尾!0039004100390052,永豐金-信義!003900410039004d,永豐金-南投!0039004100390053,永豐金-南京!0039004100360039,永豐金-屏東!0039004100390061,永豐金-苓雅!0039004100390043,永豐金-員林!0039004100370039,永豐金-埔里!003900410039004e,永豐金-桃盛!0039004100390078,永豐金-桃園!0039004100390065,永豐金-高雄!0039004100380038,永豐金-國際證券!0039004100390036,永豐金-博愛(停)!003900410039005a,永豐金-復興!0039004100380039,永豐金-敦北!0039004100380046,永豐金-敦南!0039004100390037,永豐金-新竹!0039004100390069,永豐金-新店!0039004100390048,永豐金-新莊!0039004100390032,永豐金-萬盛!0039004100390035,永豐金-經紀部!003900410039006a,永豐金-嘉義!0039004100390073,永豐金-彰化!0039004100360031,永豐金-鳳山!0039004100390071,永豐金-潮州!0039004100390051,永豐金-豐原!0039004100390041,永豐金-羅東;8840,玉山!8840,玉山證券!0038003800340041,玉山-士林!003800380034004a,玉山-大里!0038003800340042,玉山-台中!8847,玉山-台南!0038003800340044,玉山-左營!8846,玉山-板橋!0038003800340043,玉山-信義!0038003800340045,玉山-城中!0038003800340046,玉山-桃園!8843,玉山-高雄!003800380034004c,玉山-國際證券!8849,玉山-景美!0038003800340048,玉山-新竹!8842,玉山-新莊!8848,玉山-嘉義!003800380034004d,玉山-數位!8841,玉山-雙和;7080,石橋!7080,石橋證券;6380,光和!6380,光和!6382,光和-田中!6383,光和-和美!6385,光和-花壇!0036003300380044,光和-高雄!6381,光和-溪湖!0036003300380041,光和-嘉義;7000,兆豐!7000,兆豐證券!0037003000300068,兆豐-三民!7008,兆豐-三重!0037003000300053,兆豐-大同!003700300030006a,兆豐-大安!0037003000300052,兆豐-小港!0037003000300062,兆豐-中壢!0037003000300071,兆豐-內湖!003700300030004a,兆豐-公益!003700300030004c,兆豐-天母!0037003000300045,兆豐-斗南(停)!0037003000300049,兆豐-北高雄!7003,兆豐-台中!7005,兆豐-台中港!7006,兆豐-台南!0037003000300063,兆豐-民生!0037003000300058,兆豐-永和!7007,兆豐-竹北!0037003000300044,兆豐-西螺!0037003000300043,兆豐-來福!0037003000300073,兆豐-岡山!0037003000300061,兆豐-忠孝!0037003000300048,兆豐-東門!0037003000300042,兆豐-板橋!0037003000300069,兆豐-松德!0037003000300046,兆豐-虎尾!0037003000300050,兆豐-南京!0037003000300067,兆豐-南門!0037003000300057,兆豐-城中!003700300030006b,兆豐-員林!003700300030004e,兆豐-埔墘!003700300030004d,兆豐-桃園!0037003000300055,兆豐-桃鶯!003700300030005a,兆豐-高雄!003700300030006d,兆豐-國際證券!0037003000300066,兆豐-鹿港!0037003000300047,兆豐-麻豆!0037003000300070,兆豐-復興!7009,兆豐-景美!0037003000300056,兆豐-新竹!0037003000300077,兆豐-新莊!003700300030004b,兆豐-新營!7001,兆豐-嘉義!0037003000300064,兆豐-彰化!0037003000300072,兆豐-寶成;1020,合庫!1020,合庫證券!0031003000320047,合庫-三重!1021,合庫-台中!1022,合庫-台南!0031003000320043,合庫-自強!0031003000320046,合庫-西台中!0031003000320045,合庫-桃園!1023,合庫-高雄!0031003000320051,合庫-國際證券!1025,合庫-基隆!0031003000320041,合庫-新竹!1024,合庫-嘉義!1028,合庫-彰化!1029,合庫-鳳山;8380,安泰!8380,安泰!8381,安泰-大發!8382,安泰-楠梓;1260,宏遠!1260,宏遠證券!0031003200360048,宏遠-中和!003100320036004c,宏遠-台中!0031003200360044,宏遠-台南!1261,宏遠-民生!0031003200360069,宏遠-光隆!1262,宏遠-桃園!0031003200360051,宏遠-高雄!0031003200360058,宏遠-新化!0031003200360055,宏遠-館前;2180,亞東!2180,亞東!2187,亞東-台中!2185,亞東-台南!2181,亞東-板橋!2186,亞東-高雄!0032003100380041,亞東-國際證券!2184,亞東-新竹;8490,京城!8490,京城!8492,京城-嘉義;6660,和興!6660,和興;8900,法銀巴黎!8900,法銀巴黎;8700,花旗!8700,花旗;1590,花旗環球!1590,花旗環球;7690,金興!7690,金興;5860,盈溢!5860,盈溢!5862,盈溢-楠梓!5861,盈溢-籬子內;5260,美好!5260,美好!0035003200360041,美好-中和!5266,美好-中壢!5269,美好-台中(停)!5268,美好-台南!003500320036004d,美好-市政!5265,美好-苗栗!5263,美好-泰山!5264,美好-高雄!5267,美好-基隆!003500320036004b,美好-富順!5262,美好-楊梅!5261,美好-蘆洲;1440,美林!1440,美林;1480,美商高盛!1480,美商高盛;7030,致和!7030,致和證券!7031,致和-台北!7032,致和-佳里!7033,致和-府前!7035,致和-東門!7034,致和-金華!7038,致和-南京!7036,致和-高雄!0037003000330042,致和-崇德;8960,香港上海匯豐!8960,香港上海匯豐;5320,高橋!5320,高橋!5322,高橋-中壢!5323,高橋-內壢!5321,高橋-龍潭;8880,國泰!8880,國泰證券!8882,國泰-台中!8884,國泰-台南!8887,國泰-忠孝!003800380038004b,國泰-板橋!8883,國泰-松江!8885,國泰-桃園!8881,國泰-高雄!0038003800380051,國泰-國際證券!8888,國泰-敦南!003800380038004e,國泰-新竹!8886,國泰-新莊!0038003800380041,國泰-館前;7790,國票!7790,國票證券!0037003700390050,國票-九鼎!7797,國票-中正!0037003700390058,國票-中和!003700370039006d,國票-中港!7798,國票-內壢!0037003700390056,國票-天祥!7792,國票-北投!003700370039004a,國票-北高雄!0037003700390076,國票-台中!7791,國票-台東!0037003700390044,國票-台南!003700370039005a,國票-安和!003700370039006a,國票-和平!0037003700390075,國票-長城!003700370039006e,國票-南京!0037003700390065,國票-南科!0037003700390045,國票-南崁!7795,國票-南港!0037003700390072,國票-桃園!0037003700390062,國票-國際證券!003700370039007a,國票-博愛!0037003700390063,國票-敦北法人!0037003700390047,國票-新莊!0037003700390048,國票-嘉義!0037003700390057,國票-彰化;8450,康和!8450,康和!0038003400350046,康和-仁愛!0038003400350041,康和-內湖!8455,康和-台中!0038003400350055,康和-台北!8458,康和-台南!0038003400350042,康和-永和!0038003400350052,康和-石牌!8451,康和-延平!0038003400350044,康和-板橋!0038003400350053,康和-南崁!0038003400350058,康和-屏東!003800340035004a,康和-高雄!0038003400350059,康和-國際證券!8456,康和-新竹!8459,康和-嘉義!0038003400350045,康和-澎湖;5380,第一金!5380,第一金!0035003300380046,第一金-大稻埕!5389,第一金-中山!0035003300380059,第一金-中壢!5382,第一金-台中!5384,第一金-台南!0035003300380043,第一金-光復!003500330038006a,第一金-安和!0035003300380045,第一金-自由!0035003300380044,第一金-忠孝!5381,第一金-員林!5385,第一金-桃園!5383,第一金-高雄!0035003300380061,第一金-國際證券!0035003300380057,第一金-華江!0035003300380042,第一金-新竹!0035003300380041,第一金-新興!003500330038004c,第一金-經紀部!0035003300380050,第一金-路竹!003500330038004d,第一金-嘉義!5386,第一金-彰化!5387,第一金-澎湖!0035003300380049,第一金-頭份!003500330038004e,第一金-豐原;5850,統一!5850,統一!0035003800350051,統一-三多!003500380035004a,統一-三重!0035003800350059,統一-土城!003500380035004d,統一-士林!5853,統一-中壢!0035003800350063,統一-仁愛!0035003800350062,統一-內湖!5856,統一-台中!5855,統一-台南!0035003800350067,統一-平鎮!0035003800350042,統一-永和!003500380035006d,統一-竹南!0035003800350053,統一-宜蘭!0035003800350052,統一-東湖!0035003800350050,統一-板橋!003500380035005a,統一-松江!0035003800350057,統一-金門!0035003800350055,統一-南京!5854,統一-城中!5859,統一-屏東!0035003800350049,統一-員林!0035003800350048,統一-桃園!5851,統一-高雄!0035003800350073,統一-國際證券!0035003800350041,統一-基隆!5852,統一-敦南!0035003800350044,統一-新台中!5857,統一-新竹!0035003800350045,統一-新營!5858,統一-嘉義!0035003800350046,統一-彰化;9200,凱基!9200,凱基!003900320031004d,凱基-八德!9275,凱基-三多!9205,凱基-三重!0039003200310045,凱基-三峽!003900320031004a,凱基-土城!9238,凱基-士林!9291,凱基-大安!0039003200300057,凱基-大里!9218,凱基-大直!9229,凱基-中山!9202,凱基-中港!9285,凱基-中壢!0039003200310047,凱基-五股!9225,凱基-內埔!9287,凱基-內湖!0039003200310046,凱基-天母理財!9297,凱基-文心!9281,凱基-斗六!9283,凱基-北門!9204,凱基-台中!9268,凱基-台北!003900320030005a,凱基-台東!9211,凱基-台南!0039003200300044,凱基-市府!9239,凱基-市政!0039003200310043,凱基-民權!9207,凱基-永和!9278,凱基-永康!9235,凱基-永華!9226,凱基-汐止!9234,凱基-竹北!0039003200300045,凱基-竹北理財!9273,凱基-竹東!9272,凱基-竹科!9255,凱基-和平!003900320030004d,凱基-宜蘭!9209,凱基-岡山!9212,凱基-東港!0039003200310059,凱基-東勢!9257,凱基-林口!0039003200300041,凱基-板橋!9217,凱基-松山!9236,凱基-虎尾!9233,凱基-長庚!9216,凱基-信義!9256,凱基-南崁!9227,凱基-城中!0039003200320043,凱基-屏東!9254,凱基-科園!9276,凱基-苗栗!9231,凱基-員林!9288,凱基-埔墘!9208,凱基-桃園!0039003200300046,凱基-站前!9215,凱基-高美館!9206,凱基-高雄!9299,凱基-國際證券!0039003200300048,凱基-基隆!0039003200320048,凱基-復興(停)!9237,凱基-敦北!003900320030004e,凱基-湖口!0039003200300056,凱基-新店!0039003200310053,凱基-新莊!9224,凱基-新莊(停)!9266,凱基-新豐!9252,凱基-嘉義!0039003200300047,凱基-彰化!9274,凱基-鳳山!9289,凱基-興隆!9296,凱基-頭份!9203,凱基-總公司!9223,凱基-豐中!0039003200300043,凱基-雙和!9258,凱基-羅東;9600,富邦!9600,富邦證券!003900360031004b,富邦-七賢!0039003600320042,富邦-二林!0039003600330041,富邦-八德!9677,富邦-三重!003900360032004a,富邦-三峽!0039003600320059,富邦-土城(停)!003900360031004c,富邦-士林(停)!0039003600310058,富邦-大墩(停)!003900360032004b,富邦-中和(停)!9636,富邦-中壢!9676,富邦-仁愛!9627,富邦-內湖!0039003600310046,富邦-公益!0039003600320058,富邦-文化(停)!0039003600320047,富邦-斗六!003900360031004d,富邦-木柵!0039003600330042,富邦-北宜蘭(停)!0039003600320046,富邦-北桃園(停)!0039003600320051,富邦-北高雄!0039003600390043,富邦-北港!003900360035004b,富邦-台中!9623,富邦-台北!9608,富邦-台東!9667,富邦-台南!0039003600360046,富邦-左營!9654,富邦-永和!003900360031005a,富邦-永康!0039003600310047,富邦-成功(停)!9624,富邦-竹北!9625,富邦-竹東!0039003600320043,富邦-竹科!0039003600310050,富邦-和美!9686,富邦-宜蘭!9616,富邦-岡山!0039003600310045,富邦-府城(停)!0039003600310044,富邦-忠孝(停)!0039003600310057,富邦-東花蓮(停)!9655,富邦-板橋!0039003600310056,富邦-板橋中山(停)!9621,富邦-花蓮!9697,富邦-虎尾!003900360031004e,富邦-青埔!9666,富邦-南屯!0039003600310043,富邦-南京!0039003600310052,富邦-南員林!0039003600320041,富邦-南港!0039003600310059,富邦-屏東!9658,富邦-建國!9657,富邦-苗栗!0039003600310051,富邦-重新(停)!9672,富邦-員林!9665,富邦-桃園!9659,富邦-高雄!0039003600300053,富邦-國際證券!9614,富邦-基隆!0039003600320056,富邦-復興(停)!9663,富邦-敦南!0039003600310053,富邦-景美(停)!9604,富邦-陽明!0039003600320052,富邦-園區(停)!9647,富邦-新竹!9661,富邦-新店!0039003600310048,富邦-新板!0039003600320044,富邦-新莊!9693,富邦-新營!9699,富邦-經紀!9692,富邦-嘉義!0039003600350055,富邦-彰化!0039003600320048,富邦-鳳山(停)!0039003600320045,富邦-樹林!0039003600320055,富邦-縣政(停)!003900360031004a,富邦-興業(停)!0039003600320050,富邦-頭份!0039003600320057,富邦-龍潭(停)!003900360033004c,富邦-豐原!003900360032004c,富邦-雙和(停)!9634,富邦-羅東;7530,富順!7530,富順;1570,港商法國興業(停)!1570,港商法國興業(停);1560,港商野村!1560,港商野村;1360,港商麥格理!1360,港商麥格理;1530,港商德意志(停)!1530,港商德意志(停);1660,港商聯昌!1660,港商聯昌;1400,港商蘇皇!1400,港商蘇皇;6640,渣打商銀!6640,渣打商銀;9300,華南永昌!9300,華南永昌!9369,華南永昌-三重!9315,華南永昌-大甲!9307,華南永昌-大安!9323,華南永昌-小港!9359,華南永昌-中正!9337,華南永昌-內壢!9327,華南永昌-斗六!9334,華南永昌-世貿!9309,華南永昌-古亭!9302,華南永昌-台中!9306,華南永昌-台南!9312,華南永昌-民權!9329,華南永昌-朴子!9339,華南永昌-竹北!9324,華南永昌-岡山!9325,華南永昌-忠孝!9386,華南永昌-東昇!9358,華南永昌-東勢!9317,華南永昌-林口!9349,華南永昌-板橋!9377,華南永昌-虎尾!9333,華南永昌-長虹!9326,華南永昌-南京!9362,華南永昌-苗栗!9352,華南永昌-桃園!9303,華南永昌-高雄!9399,華南永昌-國際證券!9322,華南永昌-基隆!9316,華南永昌-淡水!9308,華南永昌-麻豆!9347,華南永昌-敦南!9305,華南永昌-新莊!9332,華南永昌-楠梓!9314,華南永昌-嘉義!9363,華南永昌-彰化!9331,華南永昌-鳳山!9328,華南永昌-潮州!9343,華南永昌-頭份!9366,華南永昌-豐原!9319,華南永昌-鶯歌;8710,陽信!8710,陽信!8715,陽信-台中!8714,陽信-台南!8711,陽信-石牌!8713,陽信-高雄;1650,新加坡商瑞銀!1650,新加坡商瑞銀;8560,新光!8560,新光!8561,新光-台中!8564,新光-台南!8565,新光-桃園!8562,新光-高雄!8563,新光-新竹;6210,新百王!6210,新百王;8690,新壽!8690,新壽;1520,瑞士信貸(停)!1520,瑞士信貸(停);8660,萬通(停)!8660,萬通(停);9100,群益金鼎!9100,群益金鼎!9188,群益金鼎-三民!0039003100330067,群益金鼎-三重!003900310033004e,群益金鼎-土城!9137,群益金鼎-士林!0039003100380067,群益金鼎-大甲!0039003100380065,群益金鼎-大安!0039003100380048,群益金鼎-中山!9138,群益金鼎-中港!0039003100380041,群益金鼎-中壢!0039003100380073,群益金鼎-丹鳳!0039003100380064,群益金鼎-內湖!0039003100380050,群益金鼎-天母!0039003100330052,群益金鼎-北高雄!0039003100380043,群益金鼎-古亭!9184,群益金鼎-台中!0039003100380058,群益金鼎-台北!9185,群益金鼎-台南!0039003100300044,群益金鼎-市府!9131,群益金鼎-民權!003900310038004a,群益金鼎-永和!0039003100380069,群益金鼎-竹南!9136,群益金鼎-西松!003900310038007a,群益金鼎-宜蘭!0039003100380078,群益金鼎-延平!0039003100380057,群益金鼎-忠孝!9135,群益金鼎-東大!0039003100380044,群益金鼎-東門!003900310038004b,群益金鼎-東湖!0039003100380042,群益金鼎-板橋!9103,群益金鼎-松山!0039003100380045,群益金鼎-南京!0039003100330048,群益金鼎-屏東!003900310038004c,群益金鼎-建成!9189,群益金鼎-桃園!9108,群益金鼎-海山!9105,群益金鼎-高盛!9183,群益金鼎-高雄!9199,群益金鼎-國際證券!0039003100330045,群益金鼎-基隆!0039003100330055,群益金鼎-崇德!9101,群益金鼎-敦南!9134,群益金鼎-開元!9186,群益金鼎-新竹!0039003100380046,群益金鼎-新店!0039003100380047,群益金鼎-新莊!0039003100380075,群益金鼎-瑞豐!0039003100330049,群益金鼎-萬華!003900310038004d,群益金鼎-嘉義!9187,群益金鼎-彰化!0039003100380063,群益金鼎-鳳山!0039003100330044,群益金鼎-潭子!0039003100330059,群益金鼎-館前!9182,群益金鼎-總公司;2210,群益期貨!2210,群益期貨;1230,彰銀!1230,彰銀!1232,彰銀-七賢!1233,彰銀-台中;6480,福邦!6480,福邦證券!6489,福邦-新竹;6950,福勝!6950,福勝;1040,臺銀!1040,臺銀!1043,臺銀-民權!0031003000340044,臺銀-金山!0031003000340043,臺銀-高雄!1045,臺銀-新竹!0031003000340041,臺銀-臺中!1042,臺銀-臺南!1041,臺銀-鳳山(停);6910,德信!6910,德信!6912,德信-中正!6915,德信-和平!6913,德信-新營;8440,摩根大通!8440,摩根大通;8580,聯邦商銀!8580,聯邦商銀!8585,聯邦-三重!8586,聯邦-大業!8583,聯邦-忠孝!8581,聯邦-高雄!8588,聯邦-富強!8582,聯邦-嘉義!8587,聯邦-興中!8584,聯邦-雙和;5500,豐銀!5500,豐銀;7900,豐德!7900,豐德;5690,豐興!5690,豐興;5460,寶盛!5460,寶盛
    """ # 請將您的券商清單貼在此處
    broker_list = parse_raw_broker_string(raw_broker_data)
    print(f"清單解析完成，共找到 {len(broker_list)} 個有效券商分點準備爬取。")
    if not broker_list:
        print("券商清單為空，請在 raw_broker_data 變數中填入您的清單。")
        return

    base_url = "https://fubon-ebrokerdj.fbs.com.tw/z/zg/zgb/zgb0.djhtm"
    all_records = []
    report_date = None  # ★ 新增：用於儲存資料日期
    
    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
    session = requests.Session()
    
    for i, broker in enumerate(broker_list):
        headers = {'User-Agent': random.choice(USER_AGENTS)}
        params = {'a': broker['parent_broker_code'], 'b': broker['b'], 'c': 'E', 'd': '1'}
        print(f"\n({i+1}/{len(broker_list)}) 正在爬取: {broker['branch_name']}...")
        try:
            response = session.get(base_url, params=params, timeout=10, verify=False, headers=headers)
            response.raise_for_status()
            response.encoding = 'big5'
            html_content = response.text
            broker_info = {'parent_broker_code': broker['parent_broker_code'], 'parent_broker_name': broker['parent_broker_name'], 'branch_name': broker['branch_name']}
            records_from_page, data_date = parse_page_content(html_content, broker_info)
            
            if records_from_page:
                if data_date and not report_date:
                    report_date = data_date  # ★ 修改：獲取並儲存資料日期
                for record in records_from_page:
                    record['資料日期'] = data_date if data_date else 'N/A'
                all_records.extend(records_from_page)
                print(f"✅ 成功，解析到 {len(records_from_page)} 筆紀錄 (日期: {data_date})。")
            else:
                print("⚠️ 此分點查無買賣超資料。")
        except requests.exceptions.RequestException as e:
            print(f"❌ 爬取失敗: {e}")
        sleep_time = random.uniform(10, 20)
        print(f"延遲 {sleep_time:.2f} 秒...")
        time.sleep(sleep_time)

    if not all_records:
        print("\n所有查詢皆無資料，不產生 Excel 檔案。")
        return
        
    # ★ 修改：使用 report_date 來產生動態檔名 ★
    if not report_date:
        # 如果一直沒抓到日期，給一個 fallback 檔名
        report_date = time.strftime("%Y%m%d")
    
    output_filename = f"券商分點買賣超明細_{report_date}.xlsx"
    
    print(f"\n爬取完成，總共收集到 {len(all_records)} 筆紀錄，準備寫入檔案: {output_filename}")
    df = pd.DataFrame(all_records)
    final_columns = ['資料日期', '股票代號', '股票名稱', '母券商代號', '母券商名稱', '子券商名稱', '買入張數', '賣出張數']
    df = df[final_columns]
    
    try:
        df.to_excel(output_filename, index=False, engine='openpyxl')
        print(f"\n🎉 資料已成功儲存至 '{output_filename}'")
    except Exception as e:
        print(f"❌ 儲存檔案時發生錯誤：{e}")

if __name__ == '__main__':
    main()