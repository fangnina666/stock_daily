# .github/workflows/scraper.yml

# å·¥ä½œæµç¨‹çš„åç¨±
name: Daily Stock Data Scraper

# è§¸ç™¼å·¥ä½œæµç¨‹çš„äº‹ä»¶
on:
  workflow_dispatch:
    inputs:
      stock_id:
        description: "æŒ‡å®šè‚¡ç¥¨ä»£è™Ÿ (ä¾‹å¦‚ 2330)ï¼Œä¸å¡«å‰‡æŠ“å…¨éƒ¨"
        required: false
        default: ""
      outfile_prefix:
        description: "æª”åçš„å‰ç¶´ (ä¾‹å¦‚ TSMC_report)ï¼Œä¸å¡«å‰‡ç”¨é è¨­"
        required: false
        default: ""

  # æ’ç¨‹è§¸ç™¼
  schedule:
    # "0 9 * * *" ä»£è¡¨åœ¨ UTC æ™‚é–“çš„æ¯å¤©æ—©ä¸Š 9:00 åŸ·è¡Œ
    # æ›ç®—æˆæ‚¨çš„æ™‚å€ (CST, UTC+8)ï¼Œå°±æ˜¯æ¯å¤©ä¸‹åˆ 5:00 (17:00)
    - cron: '0 9 * * 1-5'

# å®šç¾©å·¥ä½œæµç¨‹ä¸­çš„ä»»å‹™
jobs:
  scrape-data:
    # æŒ‡å®šä»»å‹™é‹è¡Œçš„è™›æ“¬ç’°å¢ƒ
    runs-on: ubuntu-latest

    # ä»»å‹™ä¸­çš„æ­¥é©Ÿ
    steps:
      # æ­¥é©Ÿ 1: å°‡æ‚¨çš„ç¨‹å¼ç¢¼å¾ GitHub repo ä¸‹è¼‰åˆ°è™›æ“¬ç’°å¢ƒä¸­
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.7' # æ‚¨å¯ä»¥æŒ‡å®šéœ€è¦çš„ Python ç‰ˆæœ¬

      # æ­¥é©Ÿ 3: å®‰è£ Python ä¾è³´å‡½å¼åº«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # æ­¥é©Ÿ 4: åŸ·è¡Œæ‚¨çš„ Python çˆ¬èŸ²è…³æœ¬
      # å°‡ 'fubon.py' æ›æˆæ‚¨ Python æª”æ¡ˆçš„å¯¦éš›åç¨±
      - name: Run scraper
        run: |
          OUTFILE=""
          if [ "${{ github.event.inputs.outfile_prefix }}" != "" ]; then
            OUTFILE="reports/${{ github.event.inputs.outfile_prefix }}.xlsx"
          fi

          if [ "${{ github.event.inputs.stock_id }}" != "" ]; then
            echo "ğŸ“Œ åªæŠ“è‚¡ç¥¨ ${{ github.event.inputs.stock_id }}"
            if [ "$OUTFILE" != "" ]; then
              python fubon.py --stock ${{ github.event.inputs.stock_id }} --outfile "$OUTFILE"
            else
              python fubon.py --stock ${{ github.event.inputs.stock_id }}
            fi
          else
            echo "ğŸ“Œ æŠ“å…¨éƒ¨è‚¡ç¥¨"
            if [ "$OUTFILE" != "" ]; then
              python fubon.py --outfile "$OUTFILE"
            else
              python fubon.py
            fi
          fi
      - name: Commit and Push report
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/
          git commit -m "Add daily report $(date +'%Y-%m-%d') [skip ci]" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥é©Ÿ 5: ä¸Šå‚³ç”¢ç”Ÿçš„ Excel æª”æ¡ˆ
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          # ä¸Šå‚³æª”æ¡ˆçš„åç¨± (åœ¨ GitHub ä¸Šé¡¯ç¤ºçš„åç¨±)
          name: broker-data-report
          # è¦ä¸Šå‚³çš„æª”æ¡ˆè·¯å¾‘ï¼Œä½¿ç”¨è¬ç”¨å­—å…ƒ * ä¾†åŒ¹é…å‹•æ…‹ç”Ÿæˆçš„æª”å
          path: reports/*.xlsx
